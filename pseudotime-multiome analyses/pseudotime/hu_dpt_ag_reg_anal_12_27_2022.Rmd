---
title: "Human Regression of Gene Expression over Pseudotime"
author: "Larry Chen"
date: "2022-12-27"
output: html_document
---

This R Markdown file takes in human data after diffusion pseudotime has been calculated, and uses Monocle3's differential expression tools to apply generalized linear regression models to the expression of each gene as a function of diffusion pseudotime.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import-libraries, message = FALSE}
#importing libraries
library(monocle3)
library(Seurat)
library(SeuratData)
library(SeuratDisk)
library(SeuratWrappers)
library(patchwork)
library(magrittr)
library(dplyr)
library(tibble)
library(anndata)
library(circlize)
library(data.table)
library(sessioninfo)
```

```{r session-info}
sessioninfo::session_info()%>%
  details::details(
    summary = 'Current session info',
    open    = TRUE
  )
```

# IMPORTING DATA

## Count Matrix

```{r import-counts}
#read in count matrix
hu_rna_concat_ag_X_raw <- fread("C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_rna_concat_ag_raw_X.csv")
hu_rna_concat_ag_X_raw = hu_rna_concat_ag_X_raw[-1,-1]
```

## Metadata

```{r import-metadata}
#read in metadata
hu_rna_concat_ag_obs <- read.csv("C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_rna_concat_ag_obs.csv")
hu_rna_concat_ag_var <- read.csv("C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_rna_concat_ag_var.csv")
hu_rna_concat_ag_pca <- read.csv("C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_rna_concat_ag_pca.csv")
hu_rna_concat_ag_umap <- read.csv("C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_rna_concat_ag_umap.csv")
hu_rna_raw_ag_var <- read.csv("C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_rna_raw_ag_var.csv")
```

# CONSTRUCTING SEURAT OBJECT

## Cleaning metadata

```{r clean-metadata}
#setting rownames for obs and var and getting rid of redundant rowname column
rownames(hu_rna_concat_ag_obs) = hu_rna_concat_ag_obs$X
hu_rna_concat_ag_obs = subset(hu_rna_concat_ag_obs, select = -c(X))
rownames(hu_rna_concat_ag_var) = hu_rna_concat_ag_var$X
hu_rna_concat_ag_var = subset(hu_rna_concat_ag_var, select= -c(X))
```

## Cleaning dimensional reductions

```{r clean-dim-reduc}
#deleting rownames for umap and pca, setting colnames, converting to matrices
hu_rna_concat_ag_pca_df = hu_rna_concat_ag_pca[,c(2:ncol(hu_rna_concat_ag_pca))]
for (i in 1:ncol(hu_rna_concat_ag_pca_df)){
  colnames(hu_rna_concat_ag_pca_df)[i] = paste0("X_pca",i)
}
rownames(hu_rna_concat_ag_pca_df) = rownames(hu_rna_concat_ag_obs)
hu_rna_concat_ag_pca_mat = data.matrix(hu_rna_concat_ag_pca_df, rownames.force = NA)

hu_rna_concat_ag_umap_df = hu_rna_concat_ag_umap[,c(2:ncol(hu_rna_concat_ag_umap))]
colnames(hu_rna_concat_ag_umap_df) = c("X_umap1","X_umap2")
rownames(hu_rna_concat_ag_umap_df) = rownames(hu_rna_concat_ag_obs)
hu_rna_concat_ag_umap_mat = data.matrix(hu_rna_concat_ag_umap_df, rownames.force = NA)
```

## Cleaning raw count matrix

```{r clean-counts}
#adding row and colnames to X
hu_rna_concat_ag_X <- t(hu_rna_concat_ag_X_raw)
colnames(hu_rna_concat_ag_X) = rownames(hu_rna_concat_ag_obs)
rownames(hu_rna_concat_ag_X) = hu_rna_raw_ag_var$X
```

## Subsetting raw count matrix to expressed genes

hu_rna_concat_ag_X has all the genes, but hu_rna_concat_ag_var only contains genes that were expressed in at least 1 cell.

```{r subset-counts}
#subset by genes that are expressed in at least one cell 
hu_rna_concat_ag_X = hu_rna_concat_ag_X[rownames(hu_rna_concat_ag_var),]
```

## Creating Seurat Object

```{r create-seurat}
#create seurat object
hu_rna_concat_ag = CreateSeuratObject(counts = hu_rna_concat_ag_X)
#add metadata to seurat object
hu_rna_concat_ag <- AddMetaData(
  object = hu_rna_concat_ag,
  metadata = hu_rna_concat_ag_obs)
```

```{r add-dim-reducs}
#add dimensional reductions to object
hu_rna_concat_ag[['umap']] <- CreateDimReducObject(embeddings = hu_rna_concat_ag_umap_mat, key = "umap_", assay = 'RNA')
hu_rna_concat_ag[['pca']] <- CreateDimReducObject(embeddings = hu_rna_concat_ag_pca_mat, key = "pca_", assay = 'RNA')
```

## Pseudotime Binning

```{r pseudo-binning}
#add pseudotime binning (to be used in downstream analysis)
binner <- function(x) {
  if(x >= 0 & x < 0.1){
    return(1)
  }
  if (x > 0.1 & x < 0.2){
    return(2)
  }
  if (x > 0.2 & x < 0.3){
    return(3)
  }
  if (x > 0.3 & x < 0.4){
    return(4)
  }
  if (x > 0.4 & x < 0.5){
    return(5)
  }
  if (x > 0.5 & x < 0.6){
    return(6)
  }
  if (x > 0.6 & x < 0.7){
    return(7)
  }
  if (x > 0.7 & x < 0.8){
    return(8)
  }
  if (x > 0.8 & x < 0.9){
    return(9)
  }
  if (x > 0.9 & x <= 1){
    return(10)
  }
}
hu_rna_concat_ag$dpt_bin = sapply(hu_rna_concat_ag$dpt_pseudotime,binner)
```

## Saving Seurat object

```{r save-seurat, eval = FALSE}
#save seurat object as RDS
saveRDS(hu_rna_concat_ag, "C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_rna_concat_ag.Rds")
```

## QC

```{r qc}
#show umap embeddings and pseudotime to make sure import went well 
Idents(hu_rna_concat_ag) = "subcell"
DimPlot(hu_rna_concat_ag, reduction = "umap")
```

```{r display-pseudo}
FeaturePlot(hu_rna_concat_ag, features = "dpt_pseudotime")
```

```{r display-pseudo-bin}
DimPlot(hu_rna_concat_ag, reduction = "umap", group.by = "dpt_bin")
```

# MONOCLE3 REGRESSION ANALYSIS

## Converting Seurat object to CDS object

```{r convert-to-monocle}
############monocle analysis###################
hu_rna_concat_ag_cds <- as.cell_data_set(hu_rna_concat_ag)
hu_rna_concat_ag_cds <- detect_genes(hu_rna_concat_ag_cds)
```

## Preprocessing

```{r mono-preprocess}
#preprocess
hu_rna_concat_ag_cds <- preprocess_cds(hu_rna_concat_ag_cds, num_dim = 50)
hu_rna_concat_ag_cds <- align_cds(hu_rna_concat_ag_cds, alignment_group = "patient")
```

## Model fitting

This step is very resource intensive.

```{r model-fitting, eval = FALSE}
#model fitting
gene_fits <- fit_models(hu_rna_concat_ag_cds, model_formula_str = "~dpt_pseudotime")
fit_coefs <- coefficient_table(gene_fits)
dpt_time_terms <- fit_coefs %>% filter(term == "dpt_pseudotime")
```

# SAVING RESULTS

## Filtering for significant results

```{r import-results, include = FALSE}
hu_ag_sig_reg_results = read.csv("C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_ag_sig_reg_results.csv", row.names = 1)
hu_ag_reg_results = read.csv("C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_ag_reg_results.csv", row.names = 1)
```

```{r filter-results, eval = FALSE}
#filter and slim the dataframe of results
hu_ag_sig_reg_results = dpt_time_terms %>% filter (q_value < 0.05) %>%
  select(gene_id, term, q_value, estimate)
hu_ag_reg_results = dpt_time_terms %>% select(gene_id,term,q_value,estimate)
```

## Saving both significant and non-significant results

```{r save-results, eval = FALSE}
#save results 
write.csv(hu_ag_sig_reg_results, "C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_ag_sig_reg_results.csv")
write.csv(hu_ag_reg_results, "C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_ag_reg_results.csv")
```

## Converting back to Seurat Object and Saving

```{r convert-back-to-seurat, eval = FALSE}
#convert cds back to seurat and save
hu_rna_concat_ag_mono <- as.Seurat(hu_rna_concat_ag_cds, assay = NULL)
saveRDS(hu_rna_concat_ag_mono, "C:/Users/Ji Lab/Documents/JID manuscript/dpt_only/hu/hu_rna_concat_ag_mono.Rds")
```
